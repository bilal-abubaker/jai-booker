<!--
 WordPress-ready Avenue-style Booking Form (single-file, no build)
 - Drop into a WordPress HTML block OR enqueue as a template/shortcode
 - Exact visual style inspired by Avenue modal (left orange brand rail + stepper)
 - Connects to MechanicDesk API for job types, unavailable days, and booking creation

 WEBHOOK CONFIG: Add ?webhook_url=YOUR_ZAPIER_WEBHOOK_URL to enable webhook functionality
 Example: https://aquamarine-halva-d42da3.netlify.app?webhook_url=https://hooks.zapier.com/hooks/catch/24563200/u128vb8/

 CONFIG: Fill your two workshop tokens + labels below in MD_WORKSHOPS.
 NOTE: For security, consider proxying API calls via your server later.
-->

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Booking</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", ui-sans-serif, system-ui, -apple-system,
          "Segoe UI", Roboto, Arial, sans-serif;
      }
      h1,
      h2,
      h3 {
        font-weight: 700;
      }
      .title,
      .btn {
        font-weight: 600;
      }
    </style>
    <style>
      :root {
        --brand: #ff7a00; /* Avenue orange */
        --brand-dark: #e86e00;

        --ink-2: #374151;
        --muted: #6b7280;
        --bg: #f8fafc;
        --card: #ffffff;
        --success: #16a34a;
        --danger: #ef4444;
        --radius: 12px;
        --shadow: 0 10px 30px rgba(0, 0, 0, 0.12);
      }
      input[type="number"]::-webkit-outer-spin-button,
      input[type="number"]::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }
      input[type="number"] {
        -moz-appearance: textfield;
      }

      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial,
          sans-serif;
        color: var(--ink);
        background: transparent;
        min-width: 100%;
      }
      img {
        width: 100%;
      }
      /* Modal Overlay */
      .a-modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 999999;
        height: 100vh;
        width: 100vw;
      }
      .a-modal.open {
        display: flex;
      }
      .a-modal::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: radial-gradient(
          circle at center,
          transparent 20%,
          rgba(0, 0, 0, 0.3) 100%
        );
        pointer-events: none;
      }
      @media (max-width: 640px) {
        .a-modal {
          padding: 0;
        }
      }

      /* Make overlay layout adaptive on small devices */
      @media (max-width: 980px) {
        .a-modal {
          align-items: stretch;
          justify-content: stretch;
        }
      }

      /* Shell */
      .a-shell {
        display: grid;
        grid-template-columns: 285px minmax(665px, 900px);
        max-width: 1200px;
        width: 950px;
        min-height: 620px;
        max-height: 100vh;
        background: var(--card);
        border-radius: 16px;
        overflow: hidden;
        box-shadow: var(--shadow);
      }
      @media (max-width: 980px) {
        .a-shell {
          grid-template-columns: 1fr;
          min-height: 100vh;
          max-height: 100vh;
          width: 100vw;
          border-radius: 0;
        }
      }
      @media (max-width: 980px) {
        .a-shell {
          grid-template-columns: 1fr;
          min-height: auto;
        }
      }

      /* Left rail */
      .a-rail {
        position: relative;
        color: #fff;
        padding: 40px 20px;
        background: #ff7a00;
        background-image: url("./covr.JPG");
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        gap: 12px;
        text-align: left;
        background-image: url("./assets/side-content.png");
      }
      .a-rail::before {
        content: "";
        background-image: url("./assets/left_after.png");
        z-index: 999;
        top: 87%;
        left: 10%;
        position: absolute;
        width: 230px;
        height: 100%;
        background-repeat: no-repeat;
        background-size: contain;
      }
      .a-rail::after {
        content: "";
        position: absolute;
        inset: 0;
        background: linear-gradient(
          179deg,
          rgb(255 122 0),
          rgb(207 198 190 / 0%)
        );
      }
      .a-rail > * {
        position: relative;
        z-index: 1;
      }
      .a-rail h2 {
        margin: 0;
        font-size: 32px;
        font-weight: 700;
        line-height: 1.1;
        white-space: pre-line;
        text-align: left;
      }
      .a-rail p {
        margin: 0;
        font-size: 18px;
        font-weight: 500;
        color: #fde7d0;
      }
      @media (max-width: 640px) {
        .a-rail h2 {
          font-size: 24px;
        }
        .a-rail p {
          font-size: 16px;
        }
        .a-rail {
          padding: 24px 16px;
          display: none;
        }
      }
      .repco {
        position: absolute;
        bottom: 48px;
        left: 20px;
        right: 20px;
        z-index: 10;
        display: flex;
        justify-content: center;
      }
      .repco img {
        object-fit: contain;
        width: 100%;
        max-width: 230px;
      }

      /* Right content */
      .a-body {
        padding: 28px 28px 0px;
        background: #f8f8fa;
        position: relative;
        display: flex;
        flex-direction: column;
        min-width: 100%;
        overflow-y: auto;
      }
      @media (max-width: 640px) {
        .a-body {
          padding: 20px 16px 0px;
        }
      }
      .a-close {
        /* position: absolute; */
        top: 25px;
        right: 25px;
        border: none;
        background: transparent;
        cursor: pointer;
        line-height: 1;
      }
      @media (max-width: 640px) {
        /* .a-close {
                position: absolute;
                top: 18px;
                right: -8px;
                border: none;
                background: transparent;
                cursor: pointer;
                line-height: 1;
                z-index: 4;
              } */
      }
      /* Powered by at bottom of a-body div */
      /* .a-body .powered {
              font-size: 12px;
              color: #0c0c0c;
              display: flex;
              gap: 6px;
              justify-content: flex-end;
              font-weight: 600;
              padding: 6px 0;
              margin-top: auto;
            } */
      /* .a-body .powered img {
              height: 14px;
              display: inline-block;
              vertical-align: middle;
            } */

      /* Top nav */
      .a-top {
        display: flex;
        align-items: center;
        width: 100%;
        /* max-width: 550px; */
        gap: 12px;
        position: sticky;
        top: 0;
        background: #f8f8fa;
        z-index: 3;
        padding-bottom: 8px;
        justify-content: space-between;
      }
      @media (max-width: 640px) {
        /* .a-body .powered {
                margin-left: 100px;
              } */
        /* .a-top {
                display: flex;
                align-items: center;
                width: 100%;
                max-width: 338px;
                gap: 12px;
                position: sticky;
                top: 0;
                background: #f8f8fa;
                z-index: 3;
                padding-bottom: 8px;
              } */
      }
      .a-back {
        border: none;
        background: transparent;
        cursor: pointer;
        font-size: 20px;
        display: flex;
        align-items: center;
        transition: all 300ms;
        color: #ff7a00;
      }
      .a-back:hover {
        transform: scale(1.1);
      }
      .a-back:active {
        transform: scale(0.95);
      }
      .a-progress {
        flex: 0.885;
        height: 6px;
        border-radius: 999px;
        background: #ebecf4;
        position: relative;
        overflow: hidden;
        margin-right: 20px;
      }
      .a-progress > span {
        position: absolute;
        left: 0;
        top: 0;
        height: 100%;
        background: var(--brand);
        width: 0;
        transition: width 0.3s ease;
      }

      h3.step-title {
        margin-bottom: 27px !important;
        margin: 12px 0 8px;
        font-size: 26px;
        text-align: center;
      }
      @media (max-height: 720px) {
        h3.step-title {
          font-size: 28px;
          margin-top: 8px;
          margin-bottom: 27px;
        }
      }
      @media (max-width: 640px) {
        h3.step-title {
          font-size: 18px;
          margin: 22px 0 6px;
          margin-bottom: 22px;
        }
      }
      p.step-sub {
        margin: 0 0 16px;
        color: var(--muted);
      }
      @media (max-width: 640px) {
        p.step-sub {
          font-size: 14px;
          margin-bottom: 12px;
        }
      }

      /* Grid selections */
      .grid {
        display: grid;
        grid-template-columns: repeat(2, 0fr);
        gap: 20px;
        justify-content: center;
      }
      @media (max-width: 640px) {
        .grid {
          grid-template-columns: 1fr;
          gap: 16px;
        }
      }
      /* #step {
              width: 100%;
              max-width: 550px;
              display: flex;
              justify-content: flex-start;
              align-items: center;
              flex-direction: column;
              overflow: hidden;
            } */
      /* Animate cards */
      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }
      .animate-fadeIn {
        animation: fadeIn 200ms ease-out forwards;
      }
      @media (max-width: 720px) {
        .grid {
          grid-template-columns: 2fr 2fr;
        }
      }

      .card {
        position: relative;
        border-radius: 4px;
        width: 240px;
        height: 150px;
        border: 1px solid #e5e7eb;
        background: var(--card);
        overflow: hidden;
        cursor: pointer;
        transition: all 200ms;
      }
      @media (max-width: 640px) {
        .card {
          width: 100%;
          max-width: 280px;
          height: 120px;
        }
      }
      .card:hover {
        border-color: var(--brand);
        background: #fef7f0;
      }
      .card.active {
        border-color: var(--brand);
        box-shadow: 0 0 0 3px rgba(255, 122, 0, 0.25);
      }
      .card .img {
        position: relative;
        height: 100%;
        background: #0b0b0b center/cover no-repeat;
        filter: brightness(0.37);
        transition: all 300ms;
      }
      .card .img::after {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: var(--brand);
        opacity: 0;
        pointer-events: none;
        transition: all 300ms;
      }
      .card:hover .img::after {
        opacity: 0.5;
      }
      .card:hover .img {
        transform: scale(1.05);
      }
      .card .title {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: #fff;
        text-align: center;
        font-weight: 700;
        font-size: 24px;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.6);
        z-index: 10;
      }
      @media (max-width: 640px) {
        .card .title {
          font-size: 20px;
        }
      }

      /* Service cards - different design */
      .service-card {
        position: relative;
        border-radius: 8px;
        width: 240px;
        height: 135px;
        border: 1px solid #afb4c0;
        background: #fff;
        overflow: hidden;
        cursor: pointer;
        transition: all 200ms;
        padding: 12px;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      @media (max-width: 640px) {
        .service-card {
          width: 100%;
          max-width: 280px;
          height: 120px;
          padding: 10px;
        }
      }
      .service-card:hover {
        border-color: var(--brand);
        background: #fef7f0;
      }
      .service-card.active {
        border-color: var(--brand);
        box-shadow: 0 0 0 3px rgba(255, 122, 0, 0.25);
      }
      .service-card .img {
        position: relative;
        height: 75px;
        background: #fff center/contain no-repeat;
        border-radius: 8px;
        overflow: hidden;
        border: 1px solid transparent;
        transition: all 200ms;
      }
      .service-card:hover .img {
        border-color: #e5e7eb;
      }
      .service-card .img img {
        object-fit: contain;
        width: 100%;
        height: 100%;
        transition: all 200ms;
      }
      .service-card:hover .img img {
        transform: scale(1.05);
      }
      .service-card .title {
        color: #000;
        text-align: left;
        font-weight: 600;
        font-size: 16px;
        margin: 0;
        padding: 0;
        z-index: 10;
      }
      @media (max-width: 640px) {
        .service-card .title {
          font-size: 15px;
        }
      }

      /* Add-on cards - different design */
      .addon-card {
        position: relative;
        border-radius: 4px;
        width: 212px;
        height: 118px;
        border: 1px solid #e5e7eb;
        background: var(--card);
        overflow: hidden;
        cursor: pointer;
        transition: all 200ms;
      }
      @media (max-width: 640px) {
        .addon-card {
          width: 100%;
          /* max-width: 250px; */
          height: 100px;
        }
      }
      .addon-card:hover {
        border-color: var(--brand);
        background: #fef7f0;
      }
      .addon-card.active {
        border-color: var(--brand);
        box-shadow: 0 0 0 3px rgba(255, 122, 0, 0.25);
      }
      .addon-card .img {
        position: relative;
        height: 100%;
        background: #0b0b0b center/cover no-repeat;
        filter: brightness(0.75);
        transition: all 300ms;
      }
      .main_box > div {
        margin: auto;
        max-width: fit-content;
      }
      .div#step {
        margin: auto;
      }
      .addon-card .img::after {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: var(--brand);
        opacity: 0;
        pointer-events: none;
        transition: all 300ms;
      }
      .addon-card:hover .img::after {
        opacity: 0.5;
      }
      .addon-card:hover .img {
        transform: scale(1.05);
      }
      .addon-card .title {
        position: absolute;
        top: 50%;
        left: 50%;
        width: 80%;
        transform: translate(-50%, -50%);
        color: #fff;
        text-align: center;
        font-weight: 700;
        font-size: 18px;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.6);
        z-index: 10;
      }
      @media (max-width: 640px) {
        .addon-card .title {
          font-size: 16px;
        }
      }

      /* Add-on Cards - Unified for mobile and desktop */
      .addon-card {
        position: relative;
        border-radius: 14px;
        width: 245px;
        height: 84px;
        border: 1px solid #e5e7eb;
        background: var(--card);
        overflow: hidden;
        cursor: pointer;
        transition: all 200ms;
        /* margin-bottom: 12px; */
      }
      .addon-card:hover {
        border-color: var(--brand);
        background: #fef7f0;
      }
      .addon-card.active {
        border-color: var(--brand);
        box-shadow: 0 0 0 3px rgba(255, 122, 0, 0.25);
      }
      .addon-card .img {
        position: relative;
        height: 100%;
        background: #0b0b0b center/cover no-repeat;
        filter: brightness(0.75);
        transition: all 300ms;
      }
      .addon-card .img::after {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: var(--brand);
        opacity: 0;
        pointer-events: none;
        transition: all 300ms;
      }
      /* spinner */
      .loader-wrap {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 40px 0;
      }
      .loader {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        border: 3px solid #e5e7eb;
        border-top-color: var(--brand);
        animation: spin 0.8s linear infinite;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      .addon-card:hover .img::after {
        opacity: 0.5;
      }
      .addon-card:hover .img {
        transform: scale(1.05);
      }
      .addon-card .title {
        position: absolute;
        top: 50%;
        left: 50%;
        width: 80%;
        transform: translate(-50%, -50%);
        color: #fff;
        text-align: center;
        font-weight: 700;
        font-size: 18px;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.6);
        z-index: 10;
      }
      .addon-mobile-content {
        filter: brightness(0.5);
      }

      /* Mobile Add-on Cards */
      @media (max-width: 640px) {
        .addon-card {
          width: 100%;
          height: 70px;
          margin-bottom: 8px;
        }
        .addon-card .img {
          display: none; /* Hide background image on mobile */
        }
        .addon-card .title {
          display: none; /* Hide overlay title on mobile */
        }
        .addon-card .addon-mobile-content {
          display: flex;
          align-items: center;
          gap: 12px;
          padding: 8px 12px;
          height: 100%;
        }
        .addon-card .addon-mobile-img {
          width: 48px;
          height: 48px;
          border-radius: 8px;
          overflow: hidden;
          flex-shrink: 0;
        }
        .addon-card .addon-mobile-img img {
          width: 100%;
          height: 100%;
          object-fit: cover;
        }
        .addon-card .addon-mobile-text {
          flex: 1;
          display: flex;
          flex-direction: column;
          justify-content: center;
        }
        .addon-card .addon-mobile-title {
          font-size: 16px;
          font-weight: 600;
          color: #000;
          margin: 0;
          line-height: 1.2;
        }
      }

      /* Mobile Add-ons Container */
      .addons-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0;
        max-width: 100%;
      }

      @media (min-width: 641px) {
        .addons-container {
          display: grid;
          grid-template-columns: repeat(2, 1fr);
          gap: 20px;
        }
      }

      @media (max-width: 640px) {
        .step-sub {
          font-size: 14px;
          margin-bottom: 16px;
          color: #6b7280;
          text-align: center;
        }
      }

      /* Form */
      .form-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
      }
      .form-grid-2 {
        grid-template-columns: repeat(2, 1fr);
      }
      .form-grid-1 {
        grid-template-columns: 1fr;
      }
      @media (max-width: 768px) {
        .bar {
          position: sticky;
          bottom: 0;
          background-color: #fff;
          padding: 10px;
        }

        div#booking-modal {
          height: 90vh;
        }
        aside.a-rail {
          display: none;
        }
        .form-section .form-row {
          display: block;
        }
      }
      @media (max-width: 840px) {
        .form-grid,
        .form-grid-2 {
          grid-template-columns: 1fr;
        }
      }
      .form-section {
        display: flex;
        flex-direction: column;
        gap: 5px;
        max-width: 600px;
        width: 100%;
      }
      @media (max-width: 640px) {
        .form-section {
          gap: 8px;
        }
      }
      .form-row {
        display: flex;
        gap: 8px;
      }
      .form-row:not(:last-child) {
        margin-bottom: 0;
      }
      .form-group {
        display: flex;
        flex-direction: column;
        gap: 4px;
        width: 100%;
      }
      .form-group label {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        font-weight: 500;
        color: #374151;
      }
      .form-group label::after {
        content: "*";
        color: #ef4444;
        font-size: 16px;
      }
      .form-group.error label::after {
        content: "* Required";
        color: #ef4444;
        font-size: 12px;
        font-weight: 400;
      }
      .form-group input,
      .form-group textarea {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        background: #fff;
        font-size: 16px;
        color: #374151;
        outline: none;
      }
      @media (max-width: 640px) {
        .form-group input,
        .form-group textarea {
          padding: 12px 14px;
          font-size: 16px;
          min-height: 48px;
        }
      }
      .form-group input:focus,
      .form-group textarea:focus {
        border-color: #ff7a00;
      }
      .form-group.error input,
      .form-group.error textarea {
        border-color: #ef4444;
      }
      .form-group.error label span {
        display: inline;
        color: #ef4444;
        font-size: 12px;
        margin-left: 8px;
      }
      .form-group.error label::after {
        content: "* Required";
        color: #ef4444;
        opacity: 1;
        font-size: 14px;
        font-weight: 500;
      }
      .form-group.error label .required-text {
        display: inline;
        color: #ef4444;
        font-size: 12px;
        margin-left: 8px;
      }
      .form-group textarea {
        min-height: 80px;
        resize: none;
      }
      input,
      select,
      textarea {
        width: 100%;
        padding: 12px 12px;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        background: #fff;
        font: inherit;
        color: var(--ink);
      }
      @media (max-width: 640px) {
        .main_box > div {
          max-width: 100% !important;
          width: 100% !important;
        }
        input,
        select,
        textarea {
          padding: 14px 16px;
          min-height: 48px;
          font-size: 16px;
        }
      }
      textarea {
        min-height: 88px;
        resize: vertical;
      }
      .addon-card.animate-fadeIn {
        display: flex;
        align-items: center;
        padding: 10px;
        gap: 10px;
      }
      .addon-card.animate-fadeIn img {
        width: 56px;
        height: 56px;
        object-fit: contain;
      }
      .addon-card.animate-fadeIn .title1 {
        font-weight: 600;
      }
      .addon-card.animate-fadeIn img {
        transition: transform 1s ease-in-out;
      }

      .addon-card.animate-fadeIn:hover img {
        transform: scale(1.2);
      }

      .bar {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        margin-top: 20px !important;
        width: 100%;
        max-width: 100% !important;
      }
      @media (max-width: 640px) {
        .bar {
          justify-content: end;
          gap: 16px;
        }
      }
      .btn {
        appearance: none;
        border: none;
        background: var(--brand);
        color: #fff;
        padding: 12px 18px;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 600;
      }
      @media (max-width: 640px) {
        .btn {
          padding: 14px 20px;
          min-height: 48px;
          font-size: 16px;
        }
      }
      .btn[disabled] {
        opacity: 0.6;
        cursor: not-allowed;
      }
      .btn.secondary {
        background: #f3f4f6;
        color: var(--ink);
      }

      .hint {
        font-size: 16px;
        color: #6b6163;
        text-align: center;
      }
      .hint1 {
        font-size: 17px;
        color: #5e5e5e;
        margin-bottom: 0;
        margin-top: 0;
        font-weight: 600;
      }
      .extraTitle {
        margin: 0;
        text-align: center;
        color: #999;
        font-size: 0.875rem;
        margin-bottom: 27px;
      }
      .noBotMar h3 {
        margin-bottom: 0px !important;
      }
      .cardy {
        color: #6b7280;
      }
      .month-icon {
        margin-left: 13px;
        display: flex;
        align-items: center;
      }
      .month-icon svg {
        width: 18px;
        height: 18px;
      }
      .toast {
        position: fixed;
        bottom: 24px;
        left: 50%;
        transform: translateX(-50%);
        background: #111827;
        color: #fff;
        padding: 10px 14px;
        border-radius: 999px;
        box-shadow: var(--shadow);
        display: none;
      }
      .toast.show {
        display: inline-block;
      }

      .success {
        display: flex;
        flex-direction: column;
        gap: 14px;
        text-align: left;
        padding: 0;
      }
      .success .hero {
        height: 160px;
        background: var(--brand) center/cover no-repeat;
        border-radius: 12px;
        margin: 8px 0 16px 0;
        position: relative;
        overflow: hidden;
      }
      @media (max-width: 640px) {
        .success .hero {
          height: 174px;
          margin: 6px 0 12px 0;
        }
      }
      .success .hero > .overlay {
        content: "";
        position: absolute;
        inset: 0;
        background: linear-gradient(
          179deg,
          rgb(255 122 0),
          rgb(207 198 190 / 0%)
        );
      }
      .success-container {
        padding: 0px 52px;
      }
      .success .hero h3 {
        position: absolute;

        justify-content: center;
        margin: 0;
        color: #fff;
        font-size: 26px;
        line-height: 1.1;
        height: 100%;
        width: 80%;
        display: flex;
        align-items: center;
        text-align: center;
        left: 10%;
      }
      @media (max-width: 640px) {
        .success-container {
          padding: 0px;
        }
        .success .hero h3 {
          font-size: 30px;
          padding: 10px;
          width: 100%;
          left: unset;
        }
      }
      .success .cardy {
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 12px;
        background: #fff;
      }
      .success .row {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 0;
      }
      .success .row + .row {
        border-top: 1px solid #eef2f7;
      }
      .success .actions {
        display: flex;
        justify-content: center;
        margin-top: 16px;
      }
      .success .actions .btn {
        min-width: 100%;
      }

      /* powered by */
      .powered {
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 12px;
        margin-bottom: 10px;
        margin-top: 10px;
      }
      /* .powered img {
              height: 14px;
              display: inline-block;
              vertical-align: middle;
            } */

      .success .tick {
        font-size: 44px;
        color: #fff;
        background: var(--success);
        width: 64px;
        height: 64px;
        display: none;
        align-items: center;
        justify-content: center;
        border-radius: 999px;
      }

      /* Appointment step look-alike (Avenue) */
      .month-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        margin: 6px 0 14px;
      }
      @media (max-width: 640px) {
        .month-row {
          flex-wrap: wrap;
          gap: 8px;
          margin: 4px 0 12px;
        }
      }
      .dateicon {
        display: flex;
        gap: 1rem;
      }
      .month-pill {
        background: var(--brand);
        color: #fff;
        border: none;
        border-radius: 4px;
        padding: 10px 14px;
        font-weight: 700;
        cursor: default;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      @media (max-width: 640px) {
        .month-pill {
          padding: 8px 12px;
          font-size: 14px;
        }
      }
      .nav-icon {
        width: 34px;
        font-size: 22px;
        height: 34px;
        border-radius: 10px;
        border: 1px solid #e5e7eb;
        background: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
      }
      @media (max-width: 640px) {
        .nav-icon {
          width: 40px;
          height: 40px;
          font-size: 20px;
        }
      }

      .daystrip {
        /* justify-content: center; */
        display: flex;
        gap: 12px;
        overflow-x: auto;
        padding-bottom: 12px;
      }
      @media (max-width: 640px) {
        .daystrip {
          gap: 8px;
          padding-bottom: 8px;
          overflow: scroll;
          display: flex;
          justify-content: space-between;
        }
      }
      .day {
        min-width: 68px;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        text-align: center;
        padding: 10px 8px;
        background: #fff;
        cursor: pointer;
      }
      @media (max-width: 980px) {
        div#step {
          max-height: 80vh;
        }
        .day {
          min-width: 72px;
          padding: 8px 6px;
        }
      }
      @media (max-height: 720px) {
        .day {
          min-width: 72px;
          padding: 12px 8px;
          min-height: 72px;
          font-size: 14px;
          height: 72px;
        }
      }

      .day .dow {
        font-size: 12px;
        color: #252525;
        margin-bottom: 6px;
      }
      .day .dnum {
        font-size: 22px;
        font-weight: 500;
      }
      .dow.active {
        color: #ff7a00;
      }
      @media (max-width: 640px) {
        .day {
          min-width: 70px;
          padding: 12px 8px;
          font-size: 14px;
        }
        .day .dnum {
          font-size: 1.5rem;
          font-weight: 500;
        }
      }
      .day.active {
        border-color: var(--brand);
        box-shadow: 0 0 0 3px rgba(255, 122, 0, 0.2);
        color: #fff;
        background-color: #ff7a00;
      }
      .day.active .dow {
        color: #fff;
      }
      .day.disabled {
        opacity: 0.5;
        pointer-events: none;
      }
      .day.disabled .dnum {
        text-decoration-line: line-through;
      }
      .slots-wrap {
        margin-top: 14px;
        max-height: 22vh;
        overflow-y: auto;
        padding-right: 6px;
      }
      .slots {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      .slots-wrap::-webkit-scrollbar {
        width: 8px;
      }
      .slots-wrap::-webkit-scrollbar-thumb {
        background: #e5e7eb;
        border-radius: 999px;
      }
      @media (max-height: 720px) {
        .slots-wrap {
          max-height: 42vh;
        }
      }
      .slot {
        display: flex;
        cursor: pointer;
        align-items: center;
        justify-content: space-between;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 14px 16px;
        background: #fff;
        transition: all 200ms;
      }
      @media (max-width: 640px) {
        .slot {
          padding: 16px;
          min-height: 48px;
          font-size: 16px;
        }
      }
      .slot.selected {
        background: #ff7a0026;
      }
      @media (max-height: 720px) {
        .slot {
          padding: 10px 12px;
        }
      }
      .slot .left {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .dot {
        width: 10px;
        height: 10px;
        border-radius: 999px;
        background: #16a34a;
      }
      .sticky-cta {
        position: sticky;
        bottom: -16px;
        padding: 12px 0 0;
        /* margin-top: 12px; */
        display: flex;
        justify-content: flex-end;
      }
      @media (max-width: 640px) {
        .sticky-cta {
          justify-content: center;
        }
      }
      .btn.book {
        min-width: 140px;
      }
      @media (max-width: 640px) {
        .btn.book {
          width: 100%;
          max-width: 200px;
        }
        .slots-wrap {
          max-height: 34vh;
        }
      }

      /* Calendar popover */
      .cal-modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 2147483647;
        height: 100vh;
        width: 100vw;
      }
      .cal-card {
        background: #fff;
        border-radius: 16px;
        box-shadow: var(--shadow);
        width: min(640px, 92vw);
        padding: 18px;
      }
      .dot-orange {
        height: 10px;
        width: 10px;
        border-radius: 999px;
        background: #ff9500;
      }
      .addon-card {
        position: relative; /* This allows the tick mark to be positioned relative to the card */
      }

      .tick-mark {
        position: absolute;
        top: 5px; /* Adjust this value to move the tick mark closer or further from the top */
        right: 5px; /* Adjust this value to move the tick mark closer or further from the right */
        font-size: 20px; /* Adjust the size of the tick mark */
        display: none; /* Initially hide the tick mark */
        color: #ff7a00;
        height: 15px;
        width: 15px;
      }

      .cal-head {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 8px;
      }
      .cal-title {
        font-weight: 700;
      }
      .cal-nav {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .cal-btn {
        width: 36px;
        height: 36px;
        border-radius: 10px;
        border: 1px solid #e5e7eb;
        background: #fff;
        cursor: pointer;
      }
      .cal-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 8px;
        padding: 10px;
      }
      .cal-dow {
        font-size: 12px;
        color: #6b7280;
        text-align: center;
      }
      .cal-cell {
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 1px solid #f1f5f9;
        background: #fff;
        cursor: pointer;
      }
      .cal-cell.disabled {
        opacity: 0.4;
        pointer-events: none;
      }
      .cal-cell.active,
      .cal-cell:hover {
        border-color: var(--brand);
        box-shadow: 0 0 0 3px rgba(255, 122, 0, 0.15);
      }

      /* Flexible toggle */
      .flex-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        /* margin-top: 35px; */
      }
      @media (max-width: 640px) {
        /* .flex-row { */
        /* flex-direction: column;
                align-items: stretch;
                gap: 16px;
                margin-top: 12px;
              } */
      }
      .switch {
        position: relative;
        width: 46px;
        height: 26px;
        background: #e5e7eb;
        border-radius: 999px;
        cursor: pointer;
        transition: 0.2s;
      }
      .switch:before {
        content: "";
        position: absolute;
        top: 3px;
        left: 3px;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: #fff;
        transition: 0.2s;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.15);
      }
      .switch.on {
        background: var(--brand);
      }
      .switch.on:before {
        left: 23px;
      }
      .flexible-label {
        display: flex;
        align-items: center;
        gap: 10px;
        color: var(--ink);
      }
      .flexible-hint {
        font-size: 12px;
        color: var(--muted);
      }
      div#svc-grid > div:last-child {
        grid-column: 1 / -1; 
        justify-self: center; 
      }
      @media (max-width: 640px) {
        .flexible-label {
          gap: 12px;
          font-size: 16px;
        }
        .flexible-hint {
          font-size: 14px;
        }
      }

      @media (max-width: 640px) {
        /* #step {
                width: 100%;
                max-width: 550px;
                display: flex;
                justify-content: flex-start;
                align-items: normal;
                flex-direction: column;
                overflow: hidden;
              } */
      }
    </style>
  </head>
  <body>
    <!-- Trigger button example; in WordPress, add class .open-booking to any link/button -->
    <button
      class="open-booking btn"
      style="position: fixed; bottom: 24px; right: 24px; z-index: 10"
    >
      Make a booking
    </button>

    <div
      id="booking-modal"
      class="a-modal"
      role="dialog"
      aria-modal="true"
      aria-label="Booking form"
    >
      <div class="a-shell">
        <aside class="a-rail">
          <h2>Seamless<br />Solutions for<br />Your Vehicle</h2>
          <p>Australia's Experts in Vehicle Compliance & Logistics.</p>
          <div class="repco">
            <img style="width: 235px" src="./logo.png" alt="" />
          </div>
        </aside>

        <section class="a-body">
          <div class="a-top">
            <button
              id="make-it-hidden1"
              class="a-back"
              aria-label="Back"
              style="visibility: hidden"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="30"
                height="30"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                class="lucide lucide-circle-arrow-left"
              >
                <circle cx="12" cy="12" r="10"></circle>
                <path d="M16 12H8"></path>
                <path d="m12 8-4 4 4 4"></path>
              </svg>
            </button>
            <div id="make-it-hidden2" class="a-progress">
              <span id="pbar"></span>
            </div>
            <button class="a-close" style="color: red" aria-label="Close">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="32"
                height="32"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                class="lucide lucide-x"
              >
                <path d="M18 6 6 18"></path>
                <path d="m6 6 12 12"></path>
              </svg>
            </button>
          </div>
          <div class="main_box" id="step"></div>
          <div id="powered" class="powered"></div>
        </section>
      </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
      /* ==========================
     CONFIG – EDIT ME
     ========================== */
      const MD_WORKSHOPS = [
        {
          id: "hendra",
          label: "Hendra",
          address: "238 Nudgee Rd, Hendra QLD 4011",
          token: "bc7158e959c07c899d3ad95ea195dd30448dd268",
          image:
            "https://embed.avenue2.au/car-one/assets/car-one/location/hendra.png",
          lastbanner: "./assets/lastbanner.png",
        },
        {
          id: "woolloongabba",
          label: "Woolloongabba",
          address: "187 Logan Rd, Woolloongabba QLD 4102, Australia",
          token: "cb34cea9a611eab94576fd50941e95631f7fa450",
          image:
            "https://embed.avenue2.au/car-one/assets/car-one/location/woolloongabba.png",
          lastbanner: "./assets/lastbanner.png",
        },
      ];
      const PHONE_DISPLAY = "(07) 3607 0215"; // shown on success screen
      const DEFAULT_DROP_HOUR = 8; // 8:00 drop-off preset
      const DEFAULT_PICKUP_HOUR = 17; // 5pm pickup preset
      const TIME_SLOTS = [
        "08:00",
        "08:30",
        "09:00",
        "09:30",
        "10:00",
        "10:30",
        "11:00",
        "11:30",
        "12:00",
        "12:30",
        "13:00",
        "13:30",
        "14:00",
        "14:30",
        "15:00",
        "15:30",
        "16:00",
        "16:30",
      ];
      const ADDONS = [
        {
          name: "Tyre Rotation and Balancing",
          image: "./assets/addonone.png",
        },
        { name: "Engine Flush Plus", image: "./assets/twoAddon.png" },
        {
          name: "A/C Clean & Deodoriser",
          image: "./assets/threeAddon.png",
        },
        {
          name: "Wiper Blade Replacement",
          image: "./assets/fourAddon.png",
        },
        {
          name: "A/C Full Service",
          image: "./assets/fiveAddon.png",
        },
        {
          name: "Car Loan (Subject to availability)",
          image: "./assets/sixAddon.png",
        },
      ];

      // Branding footer
      const KLIXIX_LOGO_URL = "REPLACE_WITH_KLIXIX_LOGO_URL";
      const SHOW_POWERED = true;
      // Left-rail images (replace with your WP Media URLs)
      const RAIL_IMAGES = [
        "https://images.unsplash.com/photo-1517048676732-d65bc937f952?q=80&w=1600&auto=format&fit=crop",
        "https://images.unsplash.com/photo-1582719478250-c89cae4dc85b?q=80&w=1600&auto=format&fit=crop",
        "https://images.unsplash.com/photo-1621665421470-9b3d2e10a1d9?q=80&w=1600&auto=format&fit=crop",
      ];

      /* ==========================
     UTILITIES
     ========================== */
      const $ = (q, root = document) => root.querySelector(q);
      const $$ = (q, root = document) => Array.from(root.querySelectorAll(q));
      const fmt2 = (n) => String(n).padStart(2, "0");
      const toMDDateTime = (d, timeStr) => {
        const [HH, MM] = timeStr.split(":");
        const dd = fmt2(d.getDate());
        const mm = fmt2(d.getMonth() + 1);
        const yyyy = d.getFullYear();
        return `${dd}/${mm}/${yyyy} ${HH}:${MM}`; // MechanicDesk format
      };
      const toast = (msg, ms = 2500) => {
        const t = $("#toast");
        t.textContent = msg;
        t.classList.add("show");
        setTimeout(() => t.classList.remove("show"), ms);
      };

      // Nearest slot helper (local time)
      function getNearestSlot(date) {
        // If no date, just return first slot
        if (!date) return TIME_SLOTS[0];
        const now = new Date();
        const sameDay =
          now.getFullYear() === date.getFullYear() &&
          now.getMonth() === date.getMonth() &&
          now.getDate() === date.getDate();
        if (!sameDay) return TIME_SLOTS[0];
        const curMins = now.getHours() * 60 + now.getMinutes();
        for (const t of TIME_SLOTS) {
          const [h, m] = t.split(":").map(Number);
          if (h * 60 + m >= curMins) return t;
        }
        return TIME_SLOTS[TIME_SLOTS.length - 1];
      }

      /* ==========================
     STATE
     ========================== */
      const state = {
        step: 0,
        stepsCount: 6,
        workshop: null,
        token: null,
        services: [],
        selectedService: null,
        date: null, // JS Date (drop-off calendar day)
        time: null, // string HH:MM
        addons: new Set(),
        form: {
          rego: "",
          make: "",
          model: "",
          year: "",
          name: "",
          email: "",
          phone: "",
          notes: "",
        },
        unavailableDays: new Set(),
        weekOffset: 0,
        flexible: false,
        loader: false,
      };

      function setProgress() {
        const pct = 16.6667 + (state.step / (state.stepsCount - 1)) * 100;
        $("#pbar").style.width = pct + "%";
        $(".a-back").style.visibility = state.step > 0 ? "visible" : "hidden";
      }

      function openModal() {
        $("#booking-modal").classList.add("open");
        // Set left-rail background image (replace URLs below with your WordPress media URLs)
        const img = RAIL_IMAGES[Math.floor(Math.random() * RAIL_IMAGES.length)];
        document.documentElement.style.setProperty(
          "--rail-image",
          `url('${img}')`
        );
        render();
        setPowered();

        // Log webhook configuration for debugging
        const webhookUrl = getWebhookUrl();
        if (webhookUrl) {
          console.log("✅ Webhook enabled:", webhookUrl);
        } else {
          console.log(
            "❌ No webhook URL configured. Add ?webhook_url=YOUR_URL to enable."
          );
        }
      }
      function closeModal() {
        $("#booking-modal").classList.remove("open");
        // Reset state to initial values
        state.step = 0;
        state.workshop = null;
        state.token = null;
        state.services = [];
        state.selectedService = null;
        state.date = null;
        state.time = null;
        state.addons = new Set();
        state.form = {
          rego: "",
          make: "",
          model: "",
          year: "",
          name: "",
          email: "",
          phone: "",
          notes: "",
        };
        state.unavailableDays = new Set();
        state.weekOffset = 0;
        state.todayDate = 0;
        state.flexible = false;
        state.loader = false;
        // Re-initialize progress
        setProgress();
      }

      $$(".open-booking").forEach((el) =>
        el.addEventListener("click", openModal)
      );
      $(".a-close").addEventListener("click", closeModal);
      $(".a-back").addEventListener("click", () => {
        if (state.step > 0) {
          state.step--;
          render();
        }
      });

      /* ==========================
     API helpers (MechanicDesk)
     ========================== */
      async function mdGetJobTypes() {
        const url = `https://www.mechanicdesk.com.au/booking_requests/available_job_types?token=${encodeURIComponent(
          state.token
        )}`;
        const res = await fetch(url);
        if (!res.ok) throw new Error("Failed to fetch job types");
        return res.json();
      }
      async function mdGetUnavailableDays(inDays = 60) {
        const url = `https://www.mechanicdesk.com.au/booking_requests/unavailable_days?token=${encodeURIComponent(
          state.token
        )}&in_days=${inDays}`;
        const res = await fetch(url);
        if (!res.ok) throw new Error("Failed to fetch unavailable days");
        return res.json();
      }
      async function mdCreateBooking(payload) {
        const res = await fetch(
          "https://www.mechanicdesk.com.au/booking_requests/create_booking",
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          }
        );
        if (!res.ok) {
          const text = await res.text();
          throw new Error(text || "Booking failed");
        }
        return res.json().catch(() => ({ ok: true }));
      }

      // Get webhook URL from query parameters (for dynamic configuration)
      function getWebhookUrl() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get("webhook_url") || urlParams.get("webhook") || null;
      }

      // Webhook function to send form data to Zapier
      async function sendToWebhook(formData) {
        const webhookUrl = getWebhookUrl();
        if (!webhookUrl) {
          console.log("No webhook URL configured - skipping webhook");
          console.log(
            "To enable webhook, add ?webhook_url=YOUR_ZAPIER_URL to the page URL"
          );
          return false;
        }

        try {
          const res = await fetch(webhookUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              // Include all form data for webhook processing
              customer: {
                name: formData.name,
                email: formData.email,
                phone: formData.phone,
              },
              vehicle: {
                make: formData.make,
                model: formData.model,
                year: formData.year,
                registration: formData.rego,
              },
              booking: {
                workshop:
                  MD_WORKSHOPS.find((w) => w.id === state.workshop)?.label ||
                  state.workshop,
                service: state.selectedService,
                date: state.date ? state.date.toLocaleDateString() : null,
                time: state.time,
                addons: Array.from(state.addons),
                notes: formData.notes,
                flexible: state.flexible,
              },
              timestamp: new Date().toISOString(),
              source: "booking_form",
            }),
          });

          if (!res.ok) {
            console.warn("Webhook failed:", res.status, res.statusText);
            return false;
          }

          const response = await res
            .json()
            .catch(() => ({ status: "success" }));
          console.log("Webhook response:", response);
          return true;
        } catch (error) {
          console.warn("Webhook error:", error);
          return false;
        }
      }

      /* ==========================
     RENDERERS
     ========================== */
      function render() {
        setProgress();
        const host = $("#step");
        host.innerHTML = "";
        // ensure user always sees header + dates without needing to zoom; scroll to top each render
        host.style.flex = "1";
        host.style.overflow = "auto";
        host.scrollTop = 0;

        // Step 0 — Select Workshop
        if (state.step === 0) {
          const wrap = document.createElement("div");
          wrap.innerHTML = `
        <h3 class="step-title">Select your workshop</h3>
        <div class="grid" id="wk-grid"></div>
      `;
          host.appendChild(wrap);
          const grid = $("#wk-grid");
          MD_WORKSHOPS.forEach((w) => {
            const item = document.createElement("div");
            item.className = "card";
            item.innerHTML = `
          <div class="img" style="background-image:url('${w.image}')"></div>
          <div class="title">${w.label}</div>
        `;
            if (state.workshop === w.id) item.classList.add("active");
            item.addEventListener("click", async () => {
              state.workshop = w.id;
              state.token = w.token;
              state.step = 1;
              state.loader = true;
              render();
              // add a loader for the api call
              // Get unavailable days from API (no loader shown)
              try {
                // add a loader for the api call in state

                const days = await mdGetUnavailableDays(60);
                // Convert API response dates from YYYY/MM/DD to YYYY-MM-DD format for calendar comparison
                const unavailableDaysArray =
                  days?.unavailable_days || days || [];
                state.unavailableDays = new Set(
                  unavailableDaysArray.map((dateStr) => {
                    if (dateStr.includes("/")) {
                      const [year, month, day] = dateStr.split("/");
                      return `${year}-${month.padStart(2, "0")}-${day.padStart(
                        2,
                        "0"
                      )}`;
                    }
                    return String(dateStr);
                  })
                );
                // state.loader = false;
                // render();
              } catch (e) {
                console.error("API Error:", e);
                state.unavailableDays = new Set();
              } finally {
                state.loader = false;
                render();
              }
            });
            grid.appendChild(item);
          });
          return; // inside render()
        }

        // Step 1 — Select a Service
        if (state.step === 1) {
          if (state.loader) {
            console.log(state.loader, "state.loader");
            const wrap1 = document.createElement("div");
            wrap1.innerHTML = `
      <h3 class="step-title">Loading services…</h3>
      <div class="loader-wrap"><div class="loader"></div></div>
    `;
            host.appendChild(wrap1);
            return; // stop here while fetching
          }

          const wrap = document.createElement("div");
          wrap.innerHTML = `
        <h3 class="step-title">Select a Service</h3>
        <p class="step-sub">${
          state.services.length > 0
            ? `Available services at ${
                MD_WORKSHOPS.find((w) => w.id === state.workshop)?.label ||
                "your selected workshop"
              }`
            : ""
        }</p>
        <div style="gap:10px" class="grid" id="svc-grid"></div>
      `;
          host.appendChild(wrap);
          const grid = $("#svc-grid");
          const FALLBACK = [
            {
              name: "General Service",
              image:
                "https://embed.avenue2.au/car-one/assets/car-one/services/general-service.png",
            },
            {
              name: "Vehicle Repairs",
              image:
                "https://embed.avenue2.au/car-one/assets/car-one/services/repairs.png",
            },
            {
              name: "Roadworthy Certificate",
              image:
                "https://embed.avenue2.au/car-one/assets/car-one/services/roadworthy.png",
            },

            {
              name: "Pre Purchase Inspection",
              image: "./assets/PrePurchaseInspection.jpeg",
            },
            {
              name: "Other Enquiry",
              image:
                "https://embed.avenue2.au/car-one/assets/car-one/services/other-enquiry.png",
            },
          ];
          // Use only fallback services
          let names = FALLBACK.map((s) => ({ name: s.name, image: s.image }));
          names.forEach((s, idx) => {
            const item = document.createElement("div");
            item.className = "service-card animate-fadeIn";
            item.style.animationDelay = `${idx * 30}ms`;
            const img =
              s.image ||
              (s.name === "General Service"
                ? FALLBACK[0].image
                : s.name === "Vehicle Repairs"
                ? FALLBACK[1].image
                : s.name === "Roadworthy Certificate"
                ? FALLBACK[2].image
                : s.name === "Other Enquiry"
                ? FALLBACK[3].image
                : FALLBACK[0].image);
            item.innerHTML = `
          <div class="img"><img src="${img}" alt=""></div>
          <p class="title">${s.name}</p>`;
            if (state.selectedService === s.name) item.classList.add("active");
            item.addEventListener("click", () => {
              state.selectedService = s.name;
              $$(".service-card", grid).forEach((c) =>
                c.classList.remove("active")
              );
              item.classList.add("active");
              state.step = 2;
              render();
            });
            grid.appendChild(item);
          });
          return;
        }

        if (state.step === 2) {
          const currentDate = new Date();
          const daysToDisplay = window.innerWidth <= 640 ? 4 : 6; // 4 dates for mobile, 6 for desktop

          // Calculate the starting date dynamically (today)
          const base = new Date(currentDate);

          // Auto-jump to first available date on mobile if initial dates are unavailable
          if (
            window.innerWidth <= 640 &&
            state.weekOffset === 0 &&
            !state.date
          ) {
            let foundAvailable = false;
            let checkOffset = 0;

            for (let i = 0; i < daysToDisplay && !foundAvailable; i++) {
              const checkDate = new Date(currentDate);
              checkDate.setDate(currentDate.getDate() + i);
              const key = `${checkDate.getFullYear()}-${fmt2(
                checkDate.getMonth() + 1
              )}-${fmt2(checkDate.getDate())}`;

              const today = new Date();
              today.setHours(0, 0, 0, 0);
              const isPast = checkDate < today;

              const now = new Date();
              const brisbaneTime = new Date(
                now.toLocaleString("en-US", { timeZone: "Australia/Brisbane" })
              );
              const currentHour = brisbaneTime.getHours();
              const currentMinute = brisbaneTime.getMinutes();
              const currentTimeInMinutes = currentHour * 60 + currentMinute;
              const brisbaneDateStr = brisbaneTime.toLocaleDateString("en-CA");
              const checkDateStr = checkDate.toLocaleDateString("en-CA");
              const isTodayAndBlocked =
                checkDateStr === brisbaneDateStr &&
                currentTimeInMinutes >= 16 * 60 + 30;

              if (
                !state.unavailableDays.has(key) &&
                !isPast &&
                !isTodayAndBlocked
              ) {
                foundAvailable = true;
                break;
              }
            }

            if (!foundAvailable) {
              for (let offset = 1; offset <= 60; offset++) {
                const checkDate = new Date(currentDate);
                checkDate.setDate(currentDate.getDate() + offset);
                const key = `${checkDate.getFullYear()}-${fmt2(
                  checkDate.getMonth() + 1
                )}-${fmt2(checkDate.getDate())}`;

                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const isPast = checkDate < today;

                if (!state.unavailableDays.has(key) && !isPast) {
                  // Calculate how many weeks to skip
                  state.weekOffset = Math.floor(offset / (daysToDisplay - 1));
                  break;
                }
              }
            }
          }

          base.setDate(base.getDate() + state.weekOffset * (daysToDisplay - 1));

          // Use daysToDisplay instead of hardcoded 6
          const days = [...Array(daysToDisplay)].map((_, i) => {
            const d = new Date(base);
            d.setDate(base.getDate() + i);
            return d;
          });

          const dayNames = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
          const todays = new Date();
          const todayIndex = todays.getDay();

          // Calculate the dynamic day names - use daysToDisplay
          const dynamicDayNames = [];
          for (let i = 0; i < daysToDisplay; i++) {
            if (state.weekOffset > 0) {
              dynamicDayNames.push(
                dayNames[
                  (todayIndex + (daysToDisplay - 1) * state.weekOffset + i) % 7
                ]
              );
            } else {
              dynamicDayNames.push(dayNames[(todayIndex + i) % 7]);
            }
          }

          const monthLabel = base.toLocaleDateString(undefined, {
            month: "long",
            year: "numeric",
          });

          const wrap = document.createElement("div");
          wrap.innerHTML = `
    <h3 class="step-title">Appointment Date and Time</h3>
    <div class="month-row">
      <button class="month-pill" id="openCal">${monthLabel}
      <span class="month-icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="chevron-down" class="svg-inline--fa fa-chevron-down ml-2" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M233.4 406.6c12.5 12.5 32.8 12.5 45.3 0l192-192c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L256 338.7 86.6 169.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l192 192z"></path></svg></span>
      </button>
      <div class="dateicon">
        <button class="nav-icon" id="prevWeek" aria-label="Previous week">‹</button>
        <button class="nav-icon" id="nextWeek" aria-label="Next week">›</button>
      </div>
    </div>
    <div class="daystrip" id="daystrip"></div>
    <hr style="border:none;border-top:1px solid #eef2f7;margin:10px 0 6px"/>
    <div class="slots-wrap"><div class="slots" id="slots"></div></div>
    <div class="flex-row">
      <label class="flexible-label" for="flexToggle">
        <span class="switch" id="flexSwitch" aria-hidden="true"></span>
        <input id="flexToggle" type="checkbox" style="display:none" />
        I'm Flexible
      </label>
      <div class="sticky-cta"><button class="btn book" id="bookTime">Book Time</button></div>
    </div>
  `;

          host.appendChild(wrap);

          const ds = $("#daystrip");
          ds.innerHTML = "";

          // Get today's date (without time part)
          const today = new Date();
          today.setHours(0, 0, 0, 0);

          // Get current time in Brisbane timezone
          const now = new Date();
          const brisbaneTime = new Date(
            now.toLocaleString("en-US", { timeZone: "Australia/Brisbane" })
          );
          const currentHour = brisbaneTime.getHours();
          const currentMinute = brisbaneTime.getMinutes();
          const currentTimeInMinutes = currentHour * 60 + currentMinute;
          const brisbaneDateStr = brisbaneTime.toLocaleDateString("en-CA"); // YYYY-MM-DD format

          // Check if today should be blocked (after 4:30 PM Brisbane time)
          const isTodayBlocked = currentTimeInMinutes >= 16 * 60 + 30;

          days.forEach((d, idx) => {
            const key = `${d.getFullYear()}-${fmt2(d.getMonth() + 1)}-${fmt2(
              d.getDate()
            )}`;
            const dateStr = d.toLocaleDateString("en-CA");
            const disabled = state.unavailableDays.has(key);
            const isPast = d < today;
            const isTodayAndBlocked =
              dateStr === brisbaneDateStr && isTodayBlocked;

            const el = document.createElement("div");
            el.className =
              "day" +
              (disabled || isPast || isTodayAndBlocked ? " disabled" : "");
            console.log(state?.unavailableDays, "state?.unavailableDays");
            // if the day is unavailable then dont select it select the next available day
            if (!state.date && !disabled && !isPast && !isTodayAndBlocked) {
              el.classList.add("active"); // Mark first available date as active
              state.date = new Date(d); // Actually select first available date
              // state.time = getNearestSlot(state.date); // Set nearest available time
            } else {
              // state?.unavailableDays is in set so we need to convert it to an array
              const unavailableDaysArray = Array.from(state?.unavailableDays);
              console.log(unavailableDaysArray, "unavailableDaysArray");
              // select the next available day
              // unavailableDaysArray.forEach((d1) => {
              //   // const key = `${d1.getFullYear()}-${fmt2(d1.getMonth() + 1)}-${fmt2(d1.getDate())}`;

              //   console.log(
              //     d1.toString(),
              //     `${d.getFullYear()}-${d.getMonth() + 1}-${d.getDate()}`,
              //     "ssss",
              //     d1.toString() !==
              //       `${d.getFullYear()}-${d.getMonth() + 1}-${
              //         d.getDate()
              //       }`
              //   );
              //   if (
              //     d1.toString() ===
              //     `${d.getFullYear()}-${d.getMonth() + 1}-${
              //       d.getDate()
              //     }`
              //   ) {
              //     console.log("selected");
              //     el.classList.add("active");
              //     state.date = new Date(d1);
              //     return;
              //   }else{
              //     console.log("selected");
              //     el.classList.add("active");
              //     state.date = new Date(d1);
              //     return;
              //   }

              // });
            }
            if (
              state.date &&
              key ===
                `${state.date.getFullYear()}-${fmt2(
                  state.date.getMonth() + 1
                )}-${fmt2(state.date.getDate())}`
            )
              el.classList.add("active");

            el.innerHTML = `<div class="dow">${
              dynamicDayNames[idx]
            }</div><div class="dnum">${fmt2(d.getDate())}</div>`;

            el.addEventListener("click", () => {
              if (disabled || isPast || isTodayAndBlocked) return;
              state.date = new Date(d);
              render(); // Re-render the calendar without affecting the week
            });

            ds.appendChild(el);
          });

          const submitBtn = document.querySelector("#bookTime");
          if (state.date && state.time) {
            submitBtn.disabled = false;
          } else {
            submitBtn.disabled = true;
          }

          function paintSlots() {
            console.log("runn11");
            const list = $("#slots");
            list.innerHTML = "";

            // Get current time in Brisbane timezone
            const now = new Date();
            const brisbaneTime = new Date(
              now.toLocaleString("en-US", { timeZone: "Australia/Brisbane" })
            );
            const currentHour = brisbaneTime.getHours();
            const currentMinute = brisbaneTime.getMinutes();
            const currentTimeInMinutes = currentHour * 60 + currentMinute;

            // Check if selected date is today in Brisbane
            const selectedDate = state.date ? new Date(state.date) : null;
            const brisbaneDateStr = brisbaneTime.toLocaleDateString("en-CA"); // YYYY-MM-DD format
            const selectedDateStr = selectedDate
              ? selectedDate.toLocaleDateString("en-CA")
              : null;
            const isToday = brisbaneDateStr === selectedDateStr;

            // If current time is after 4:30 PM (16:30), disable today
            if (isToday && currentTimeInMinutes >= 16 * 60 + 30) {
              // Block the entire day - no slots available
              list.innerHTML =
                '<div style="padding: 20px; text-align: center; color: #999;">No available slots for today. Please select another date.</div>';
              return;
            }

            TIME_SLOTS.forEach((t) => {
              const [hourStr, minStr] = t.split(":");
              const hour = parseInt(hourStr);
              const minute = parseInt(minStr);
              const slotTimeInMinutes = hour * 60 + minute;
              const ampm = hour >= 12 ? "PM" : "AM";
              const displayHour =
                hour === 0 ? 12 : hour > 12 ? hour - 12 : hour;
              const displayTime = `${displayHour}:${minStr} ${ampm}`;

              const row = document.createElement("div");
              row.className = "slot";

              // ONLY disable slots that are in the past if selected date is TODAY
              const isPastSlot =
                isToday && slotTimeInMinutes <= currentTimeInMinutes;

              if (isPastSlot) {
                row.classList.add("disabled");
                row.style.opacity = "0.5";
                row.style.cursor = "not-allowed";
              }

              row.innerHTML = `<div class=\"left\"><div>${displayTime}</div></div><div class= ${
                hour >= 10 ? "dot-orange" : "dot"
              }></div>`;

              // Allow selection if not a past slot (or if it's a future date, allow all slots)
              if (state.time === t && !isPastSlot) {
                row.style.borderColor = "var(--brand)";
                row.classList.add("selected");
              }

              row.addEventListener("click", () => {
                // ONLY prevent clicks on past slots for today's date
                if (isPastSlot) return;
                submitBtn.disabled = false;
                state.time = t;
                $$(".slot", list).forEach((s) => {
                  s.style.borderColor = "#e5e7eb";
                  s.classList.remove("selected");
                });
                row.style.borderColor = "var(--brand)";
                row.classList.add("selected");
              });
              list.appendChild(row);
            });
          }
          paintSlots();

          // Month calendar popover
          $("#openCal").addEventListener("click", () =>
            openCalendar(state.date || base)
          );

          // Week navigation
          $("#prevWeek").addEventListener("click", () => {
            state.weekOffset--;
            render();
          });
          $("#nextWeek").addEventListener("click", () => {
            const todays = new Date();
            const todayIndex = todays.getDay();
            if (state.weekOffset === 0) {
              state.todayDate = (todayIndex + (daysToDisplay - 1)) % 7;
            } else {
              state.todayDate = (state.todayDate + (daysToDisplay - 1)) % 7;
            }
            state.weekOffset++;

            // get the day of the week for each of the next days
            console.log(state.todayDate, "state.todayDate");

            render();
          });

          // Flexible toggle
          const flexToggle = $("#flexToggle");
          const flexSwitch = $("#flexSwitch");
          const syncSwitch = () => {
            flexSwitch.classList.toggle("on", state.flexible);
          };
          flexToggle.addEventListener("change", () => {
            state.flexible = flexToggle.checked;
            syncSwitch();
            if (state.flexible && state.date) {
              state.time = getNearestSlot(state.date);
              paintSlots();
            }
          });
          // initialize from state
          flexToggle.checked = state.flexible;
          syncSwitch();
          console.log(state.date, "state.date");

          // Next
          $("#bookTime").addEventListener("click", () => {
            if (!state.date) {
              toast("Please select a date");
              return;
            }
            if (!state.time && state.flexible) {
              state.time = getNearestSlot(state.date);
            }
            if (!state.time) {
              toast("Please select time");
              return;
            }
            state.step = 3;
            render();
          });
          return;
        }
        // Step 3 — Add-ons

        if (state.step === 3) {
          const wrap = document.createElement("div");
          wrap.innerHTML = `
    <div class="noBotMar">
      <h3 class="step-title">Do you need anything else?</h3>
    </div>
    <p class="extraTitle">
      Extra charges apply for add-ons.
    </p>
    <div class="addons-container" id="addons"></div>
  `;
          host.appendChild(wrap);
          const c = $("#addons");
          ADDONS.forEach((obj, idx) => {
            const row = document.createElement("div");
            row.className = "addon-card animate-fadeIn";
            row.style.animationDelay = `${idx * 30}ms`;

            // Create the SVG for the checkmark
            const tickMark = document.createElement("span");
            tickMark.className = "tick-mark";
            tickMark.innerHTML = `
      <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="circle-check" class="svg-inline--fa fa-circle-check text-primary text-l" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
        <path fill="currentColor" d="M256 512A256 256 0 1 0 256 0a256 256 0 1 0 0 512zM369 209L241 337c-9.4 9.4-24.6 9.4-33.9 0l-64-64c-9.4-9.4-9.4-24.6 0-33.9s24.6-9.4 33.9 0l47 47L335 175c9.4-9.4 24.6-9.4 33.9 0s9.4 24.6 0 33.9z"></path>
      </svg>
    `;

            // Use responsive design - CSS will handle mobile vs desktop layouts
            row.innerHTML = `
      <img src="${obj.image}" alt="${obj.name}">
      <div class="title1">${obj.name}</div>
    `;
            row.appendChild(tickMark); // Append the tick mark to the row

            if (state.addons.has(obj.name)) {
              row.classList.add("active");
              tickMark.style.display = "block"; // Show the tick mark if active
            } else {
              tickMark.style.display = "none"; // Hide the tick mark if not active
            }

            row.addEventListener("click", () => {
              const picked = row.classList.toggle("active");
              picked
                ? state.addons.add(obj.name)
                : state.addons.delete(obj.name);

              // Toggle tick mark visibility when card is active or inactive
              tickMark.style.display = picked ? "block" : "none";
            });

            c.appendChild(row);
          });

          const bar = document.createElement("div");
          bar.className = "bar";
          const skip = Object.assign(document.createElement("button"), {
            className: "btn secondary",
            textContent: "Skip",
          });
          skip.addEventListener("click", () => {
            state.step = 4;
            render();
          });
          const next = Object.assign(document.createElement("button"), {
            className: "btn",
            textContent: "Next",
          });
          next.addEventListener("click", () => {
            state.step = 4;
            render();
          });
          bar.append(skip, next);
          host.appendChild(bar);
          return;
        }

        // Step 4 — Vehicle & Contact
        if (state.step === 4) {
          const f = state.form;
          const wrap = document.createElement("div");
          wrap.innerHTML = `
    <div style="margin-bottom:27px;text-align:center;">
      <h3 class="step-title">Vehicle & Contact Details</h3>
    </div>
    <div class="form-section">
      <div class="form-row">
        <div class="form-group">
          <label>Make</label>
          <input id="make" placeholder="e.g. Mitsubishi" value="${f.make}">
        </div>
        <div class="form-group">
          <label>Model</label>
          <input id="model" placeholder="e.g. Triton" value="${f.model}">
        </div>
        <div class="form-group">
          <label>Year<span style="display:none">Must be a valid year</span></label>
          <input id="year" type="number" placeholder="e.g. 2024" value="${f.year}">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Rego</label>
          <input id="rego" placeholder="e.g. ABC123" value="${f.rego}">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Full Name</label>
          <input id="name" placeholder="First and last name" value="${f.name}">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Email</label>
          <input id="email" type="email" placeholder="yourname@example.com" value="${f.email}">
        </div>
        <div class="form-group">
          <label>Phone Number</label>
          <input id="phone" inputmode="numeric" maxlength="13" placeholder="+61" value="${f.phone}">
        </div>
      </div>
      <div class="form-row">
        <div style="width:100%;">
          <label style="margin-bottom:0;">Additional Information</label>
          <textarea id="notes" placeholder="Extra information about your booking or vehicle">${f.notes}</textarea>
        </div>
      </div>
    </div>
  `;
          host.appendChild(wrap);

           // Ensure the phone number is cleaned up and only allows 13 digits
           function enforcePhoneDigits(el) {
            const digits = el.value.replace(/\D/g, "").slice(0, 13); // Allow only digits and limit to 13
            if (el.value !== digits) el.value = digits; // Update the value with cleaned digits
          }

          // Function to check if phone number is valid (minimum 8, maximum 13 digits)
          function isPhoneValid() {
            const el = document.getElementById("phone");
            return /^\d{8,13}$/.test(el.value); // Valid if between 8 and 13 digits
          }

          // Form field validation
          function validateField(fieldId) {
            const el = document.getElementById(fieldId);
            const group = el.closest(".form-group");
            group.classList.remove("error");

            if (fieldId === "phone") {
              const isValid = /^\d{13}$/.test(el.value); // Check if exactly 13 digits
              if (!isValid) {
                group.classList.add("error");
                return false;
              }
            }

            return true;
          }

          // Check if all required fields are filled correctly
          function checkRequiredFields() {
            const required = [
              "make",
              "model",
              "year",
              "rego",
              "name",
              "email",
              "phone",
            ];
            return required.every((id) => {
              const el = document.getElementById(id);
              return el && el.value && String(el.value).trim() !== "";
            });
          }

          // Function to update the submit button's disabled state
          function updateSubmitButton() {
            const submitBtn = document.querySelector("#step .bar .btn");
            if (submitBtn) {
              const allFilled = checkRequiredFields();
              const yearOk = validateField("year");
              const emailOk = validateField("email");
              const phoneOk = isPhoneValid(); // Validate phone number

              submitBtn.disabled = !(allFilled && yearOk && emailOk && phoneOk);

              const required = [
                "make",
                "model",
                "year",
                "rego",
                "name",
                "email",
                "phone",
              ];
              required.forEach((id) => {
                const el = document.getElementById(id);
                const group = el?.closest(".form-group");
                if (group && touchedFields.has(id)) {
                  const empty = !el.value || String(el.value).trim() === "";
                  const badPhone = id === "phone" && !isPhoneValid();
                  if (empty || badPhone) group.classList.add("error");
                  else group.classList.remove("error");
                }
              });
            }
          }

          // Add event listeners for form inputs
          [
            "make",
            "model",
            "year",
            "rego",
            "name",
            "email",
            "phone",
            "notes",
          ].forEach((id) => {
            const el = document.getElementById(id);
            const updateButton = () => {
              state.form[id] = el.value;
              validateField(id);
              updateSubmitButton();
            };

            const clearErrorOnInput = () => {
              const group = el.closest(".form-group");
              if (group && group.classList.contains("error")) {
                group.classList.remove("error");
              }
            };

            el.addEventListener("focus", (e) => {
              touchedFields.add(id);
            });

            el.addEventListener("blur", (e) => {
              const group = el.closest(".form-group");
              if (group && touchedFields.has(id)) {
                if (!el.value || String(el.value).trim() === "") {
                  group.classList.add("error");
                } else {
                  group.classList.remove("error");
                }
              }
              updateSubmitButton();
            });

            el.addEventListener("input", (e) => {
              // For phone number input, enforce digits only and max 9 characters
              if (id === "phone") {
                enforcePhoneDigits(el);
              }
              updateButton();
              clearErrorOnInput();
            });

            el.addEventListener("change", (e) => {
              updateButton();
              clearErrorOnInput();
            });

            el.addEventListener("paste", (e) => {
              updateButton();
              clearErrorOnInput();
            });

            el.addEventListener("keyup", (e) => {
              updateButton();
              clearErrorOnInput();
            });
          });

          // Create submit button with event listener for form submission
          const bar = document.createElement("div");
          bar.className = "bar";
          const submit = Object.assign(document.createElement("button"), {
            className: "btn",
            textContent: "Submit",
          });
          submit.addEventListener("click", submitBooking);

          // Initially disable submit button until all required fields are filled
          submit.disabled = true;

          bar.appendChild(submit);
          host.appendChild(bar);

          // Update submit button state based on current form values
          updateSubmitButton();
          return;
        }

        // Step 5 — Success banner + details + close button
        if (state.step === 5) {
          document.getElementById("make-it-hidden1").style.visibility =
            "hidden";
          document.getElementById("make-it-hidden2").style.visibility =
            "hidden";
          const s = document.createElement("div");
          s.className = "success";
          const w = MD_WORKSHOPS.find((w) => w.id === state.workshop) || {};
          const when = `${state.date.toLocaleDateString()} ${state.time}`;
          // just add day and date like Saturday 25th October 2025
          const formattedDate = state.date.toLocaleDateString(undefined, {
            weekday: "long", // Full name of the weekday (e.g., "Saturday")
            day: "numeric", // Day of the month (e.g., "25")
            month: "long", // Full name of the month (e.g., "October")
            year: "numeric", // Full year (e.g., "2025")
          });
          const heroImg = w.lastbanner || "";
          s.innerHTML = `
          <div class="success-container">
        <div class="hero" style="background-image:url('${heroImg}')">
          <div class="overlay"></div>
          <h3>Thank you, your booking request has been received!</h3>
        </div>
        <p class="hint1">
          Your booking request for
        </p>
        <div class="cardy">
          <div class="row"> <img src="./assets/locationIcon.png" alt="location" style="width: 20px;height: 20px;"> <span>${
            w.address || ""
          }</span></div>
          <div class="row">
            <img src="./assets/calendarIcon.png" alt="calendar" style="width: 20px;height: 20px;">
            <span>
            ${formattedDate}
            </span></div>
            <div class="row">
              <img src="./assets/clockIcon.png" alt="time" style="width: 20px;height: 20px;">
              
              <span>
                ${state.time} ${state.time > "11:59" ? "PM" : "AM"}

                </span>
            </div>
        </div>
        <p class="hint">Please check your emails for a confirmation of submission. If you want to make changes to your bookings or have any other enquiry, please call us at

<a style="color: #f88b00;" href="tel:${PHONE_DISPLAY}">${PHONE_DISPLAY}</a> 

        <div class="actions"><button class="btn" id="closeDone">Close</button></div>
        </div>
      `;
          host.appendChild(s);
          $("#closeDone").addEventListener("click", closeModal);
          return;
        }
      }

      function validateField(fieldId) {
        const el = document.getElementById(fieldId);
        const group = el.closest(".form-group");
        group.classList.remove("error");

        if (fieldId === "year") {
          const year = parseInt(el.value);
          const currentYear = new Date().getFullYear();
          if (el.value && (isNaN(year) || year < 1900)) {
            group.classList.add("error");
            return false;
          }
        }

        if (fieldId === "email") {
          if (el.value && el.value.indexOf("@") === -1) {
            group.classList.add("error");
            return false;
          }
        }

        return true;
      }

      function checkRequiredFields() {
        const required = [
          "make",
          "model",
          "year",
          "rego",
          "name",
          "email",
          "phone",
        ];
        return required.every((id) => {
          const el = document.getElementById(id);
          return el && el.value && String(el.value).trim() !== "";
        });
      }

      // Track which fields have been interacted with
      const touchedFields = new Set();

      function updateSubmitButton() {
        const submitBtn = document.querySelector("#step .bar .btn");
        if (submitBtn) {
          const required = [
            "make",
            "model",
            "year",
            "rego",
            "name",
            "email",
            "phone",
          ];
          const allFilled = checkRequiredFields();
          submitBtn.disabled = !allFilled;

          // Show/hide error styling only for touched empty required fields
          required.forEach((id) => {
            const el = document.getElementById(id);
            const group = el?.closest(".form-group");
            if (group && touchedFields.has(id)) {
              if (!el.value || String(el.value).trim() === "") {
                group.classList.add("error");
              } else {
                group.classList.remove("error");
              }
            }
          });
        }
      }

      function validateForm() {
        const required = [
          "make",
          "model",
          "year",
          "rego",
          "name",
          "email",
          "phone",
        ];
        let valid = true;

        required.forEach((id) => {
          const el = document.getElementById(id);
          const group = el.closest(".form-group");
          if (!el.value || String(el.value).trim() === "") {
            group.classList.add("error");
            valid = false;
          } else {
            group.classList.remove("error");
          }
        });

        // Validate year and email specifically
        if (!validateField("year")) valid = false;
        if (!validateField("email")) valid = false;

        return valid;
      }

      async function submitBooking() {
        // Basic validation
        if (!validateForm()) {
          toast("Please complete all required fields correctly");
          return;
        }

        const f = state.form;
        if (!state.date || !state.time || !state.selectedService) {
          toast("Please select service, date and time");
          return;
        }

        // Build payload per MechanicDesk
        const drop = toMDDateTime(state.date, state.time);
        const pickDate = new Date(state.date);
        pickDate.setHours(DEFAULT_PICKUP_HOUR, 0, 0, 0);
        const pickup = toMDDateTime(
          pickDate,
          `${fmt2(DEFAULT_PICKUP_HOUR)}:00`
        );
        const payload = {
          token: state.token,
          name: f.name,
          email: f.email,
          phone: f.phone,
          registration_number: f.rego,
          make: f.make,
          model: f.model,
          year: f.year,
          drop_off_time: drop,
          pickup_time: pickup,
          job_type_names: [state.selectedService],
          note: [
            state.selectedService
              ? `Service Type: ${state.selectedService}`
              : "",
            state.addons.size > 0
              ? `Extras: ${Array.from(state.addons).join(", ")}`
              : "",
            f.notes,
          ]
            .filter(Boolean)
            .join("\n"),
        };

        // Select the submit button within the current step area for reliability
        const btn = document.querySelector("#step .bar .btn");
        try {
          btn && ((btn.disabled = true), (btn.textContent = "Submitting…"));

          // Send to MechanicDesk API and webhook simultaneously
          const [mdResult, webhookResult] = await Promise.allSettled([
            mdCreateBooking(payload),
            sendToWebhook(f),
          ]);

          // Check if MechanicDesk booking was successful
          if (mdResult.status === "rejected") {
            throw mdResult.reason;
          }

          // Log webhook result but don't fail the booking if webhook fails
          if (webhookResult.status === "fulfilled") {
            console.log("Webhook sent successfully:", webhookResult.value);
          } else {
            console.warn(
              "Webhook failed but booking succeeded:",
              webhookResult.reason
            );
          }

          if (window.location.search.includes("thankyou_url")) {
            window.location.href = "https://car-one.com.au/thank-you-quote-g/";
          } else {
            // Proceed to Step 5 if no thankyou_url is found
            state.step = 5;
            render();
          }
        } catch (e) {
          console.error(e);
          toast("Submission failed. Please try again or call us.");
          btn && ((btn.disabled = false), (btn.textContent = "Submit"));
        }
      }

      function openCalendar(refDate) {
        let view = new Date(refDate);
        view.setDate(1);
        const overlay = document.createElement("div");
        overlay.className = "cal-modal";
        const card = document.createElement("div");
        card.className = "cal-card";
        overlay.appendChild(card);

        function renderCal() {
          card.innerHTML = "";
          const head = document.createElement("div");
          head.className = "cal-head";
          const title = document.createElement("div");
          title.className = "cal-title";
          title.textContent = view.toLocaleDateString(undefined, {
            month: "long",
            year: "numeric",
          });
          // add cross icon to close the calendar after cal-nav and when i click on it it should close the calendar

          const nav = document.createElement("div");
          nav.className = "cal-nav";
          const cross = document.createElement("div");
          cross.className = "cal-cross";
          cross.style.cursor = "pointer";
          cross.style.color = "red";
          cross.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
          `;
          cross.addEventListener("click", () => {
            overlay.remove();
          });

          const prev = document.createElement("button");
          prev.className = "cal-btn";
          prev.textContent = "‹";
          const next = document.createElement("button");
          next.className = "cal-btn";
          next.textContent = "›";
          prev.addEventListener("click", () => {
            view.setMonth(view.getMonth() - 1);
            renderCal();
          });
          next.addEventListener("click", () => {
            view.setMonth(view.getMonth() + 1);
            renderCal();
          });
          nav.append(prev, next);
          nav.appendChild(cross);

          head.append(title, nav);
          card.appendChild(head);

          const grid = document.createElement("div");
          grid.className = "cal-grid";
          const dows = ["Su", "Mo", "Tu", "We", "Th", "Fr", "Sa"];
          dows.forEach((d) => {
            const x = document.createElement("div");
            x.className = "cal-dow";
            x.textContent = d;
            grid.appendChild(x);
          });

          const firstDow = new Date(
            view.getFullYear(),
            view.getMonth(),
            1
          ).getDay();
          const daysInMonth = new Date(
            view.getFullYear(),
            view.getMonth() + 1,
            0
          ).getDate();
          // pad blanks
          for (let i = 0; i < firstDow; i++) {
            const b = document.createElement("div");
            grid.appendChild(b);
          }
          for (let day = 1; day <= daysInMonth; day++) {
            const d = new Date(view.getFullYear(), view.getMonth(), day);
            const key = `${d.getFullYear()}-${fmt2(d.getMonth() + 1)}-${fmt2(
              d.getDate()
            )}`;
            const cell = document.createElement("div");
            cell.className = "cal-cell";
            cell.textContent = fmt2(day);

            // Disable past dates and unavailable dates
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const isPast = d < today;
            const isDisabled = state.unavailableDays.has(key) || isPast;

            if (isDisabled) cell.classList.add("disabled");
            // Highlight today's date
            // if (
            //   today.getFullYear() === d.getFullYear() &&
            //   today.getMonth() === d.getMonth() &&
            //   today.getDate() === d.getDate()
            // ) {
            //   cell.classList.add("active"); // Mark today as selected
            // }
            // Check if the current date matches the selected date in state
            if (state.date && d.toDateString() === state.date.toDateString()) {
              cell.classList.add("active");
            }

            cell.addEventListener("click", () => {
              if (isDisabled || isPast) return;

              // Remove active class from all cells
              const allCells = grid.querySelectorAll(".cal-cell");
              allCells.forEach((c) => c.classList.remove("active"));

              // Add active class to clicked cell
              cell.classList.add("active");

              state.date = new Date(d);

              // Calculate week offset for selected date to show that week
              const daysToDisplay = window.innerWidth <= 640 ? 4 : 6;
              const today = new Date();
              today.setHours(0, 0, 0, 0);

              // Calculate days difference from today
              const diffTime = state.date.getTime() - today.getTime();
              const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

              // Calculate which week this date falls in
              if (diffDays >= 0) {
                state.weekOffset = Math.floor(diffDays / (daysToDisplay - 1));
              } else {
                state.weekOffset = 0;
              }

              if (state.flexible) state.time = getNearestSlot(state.date);

              // Close calendar and re-render
              overlay.remove();
              render();
            });
            grid.appendChild(cell);
          }
          card.appendChild(grid);
        }

        renderCal();
        overlay.addEventListener("click", (e) => {
          if (e.target === overlay) overlay.remove();
        });
        document.body.appendChild(overlay);
      }

      function setPowered() {
        if (!SHOW_POWERED) return;
        const el = document.getElementById("powered");
        if (!el) return;

        el.style.cursor = "pointer";
        el.addEventListener("click", () => {
          window.open("https://klixix.com", "_blank");
        });

        el.innerHTML = `Powered by <img src="./assets/klixix.png" alt="Klixix" style="width: 45px; margin-left: 8px; height: auto;">`;
      }

      // ===== Tiny inline tests (non-blocking) =====
      // These run once to sanity check date formatting & guards
      try {
        console.group("Booking widget self-test");
        const d = new Date("2025-10-13T00:00:00");
        console.assert(fmt2(8) === "08", "fmt2 left pads");
        console.assert(
          toMDDateTime(d, "11:07") === "13/10/2025 11:07",
          "toMDDateTime formats dd/mm/yyyy HH:MM"
        );
        // New tests
        const d2 = new Date("2025-12-05T00:00:00");
        console.assert(
          toMDDateTime(d2, "08:00").startsWith("05/12/2025"),
          "date part formats correctly"
        );
        console.assert(
          typeof state === "object" && state.step === 0,
          "state bootstraps correctly"
        );
        console.assert(
          Array.isArray(TIME_SLOTS) && TIME_SLOTS.length > 0,
          "time slots available"
        );
        console.assert(state.stepsCount === 6, "steps count correct");
        // console.assert(
        //   getNearestSlot(new Date()) !== undefined,
        //   "nearest slot returns a value"
        // );
        console.groupEnd();
      } catch {
        /* ignore */
      }

      // Boot immediately for environments without a separate trigger
      // Remove this if you ONLY want to open from a button
      // openModal();
    </script>
  </body>
</html>
